# Suzuki-Miyaura-Automation

## Workflow of Optimization Campaign
### 1. Input and Execution of 4 Experiments by Chemspeed Platform and SFC Analysis
Both processes were performed by input file `input_for_chemspeed.csv` and controlled by the specialized software AutoSuite for the Chemspeed platform.
### 2. Output of SFC Spectrum
Four spectrum files `***_result.csv` were generated by the SFC software.
### 3. Integration and Error Detection for SFC Spectrum
This was carried out by `evaluate_objective.bat` (a wrapper for `evaluated_objective_2024_06_25.exe`).
### 4. Decision of Next Experimental Conditions by Gaussian Process Regression
This was performed by `decision_by_nimsos.bat` (a wrapper for `decision_by_nimsos_2024_06_21.exe`). Four experiments were proposed, and the input file `input_for_chemspeed.csv` was generated.
### 5. Execution of Next Experimental Conditions
The AutoSuite system read the input file `input_for_chemspeed.csv` and executed the experiments accordingly.

## Details of Workflow
## 1. Input and Execution of 4 Experiments by Chemspeed Platform and SFC Analysis
An AutoSuite program in the Chemspeed system can read a CSV file as input. The file `input_for_chemspeed.csv` serves as the actual input to the Chemspeed system. This file contains a header in the first row and four experimental conditions in the following four rows. Each row includes three integer values, separated by commas, representing the reagent numbers of 15 ligands, 10 bases, and 10 solvents. From the second batch onward, this file is automatically updated by the `decision_by_nimsos.bat` script.

## 2. Output of SFC Spectrum
The SFC system output two files, `***_result.csv` and `***_profile.csv`, for each experiment. The `***_result.csv` file contains the actual chromatogram, while the 
 `***_profile.csv` file records the pressure profile of the CO2 pump in the SFC system. After analyzing four executed experiments, a total of eight files were generated.

## 3. Integration and Error Detection for SFC Spectrum
`evaluate_objective.bat` program read eight files `***_result.csv` and `***_profile.csv`, detected errors in the SFC analysis, and calculated the yield of desired product from each spectrum. The results were written to `candidates.csv` as yields. In case of detection of error, the corresponding results were not added to `candidates.csv`.

- Parameters of `param.txt`
    - STD_MW: molecular weight of standard
    - SUB_MW: molecular weight of the substrate
    - MV_LEN: wavelength for integration
    - STD_INI: starting point of integration of STD
    - STD_FIN: ending point of integration of STD
    - P1_INI: starting point of integration of p1 (starting material, compound 1)
    - P1_FIN: starting point of integration of p1 (starting material, compound 1)
    - P1_SLP: slope of the calibration curve
    - P2_INI: starting point of integration of p2 (starting material, product 3)
    - P2_FIN: starting point of integration of p2 (starting material, product 3)
    - P2_SLP: slope of the calibration curve
    - P3_INI: starting point of integration of p3 (starting material, by-product 4)
    - P3_FIN: starting point of integration of p3 (starting material, by-product 4)
    - P3_SLP: slope of the calibration curve
    - STD_WT: actual weight of STD
    - SUB_WT: actual weight of the substrate
    - BL_AVE: area of baseline correction
    - LOW_PS: lower limit of pressure of SFC system
    - UPR_PS: upper limit of pressure of SFC system

## 4. Decision of Next Experimental Conditions by Gaussian Process Regression
Training and evaluation in `decision_by_nimsos.bat` during the optimization campaign using Gaussian Process Regression were conducted with the PHYSBO optimizer, which was accessed through the NIMS-OS library (now renamed NIMO). The resulting next input file `input_for_chemspeed.csv` was generated upon completion of the Bayesian optimization. All experimental data obtained up to that point, stored in `candidates.csv` were used for training, and hyperparameter tuning was automatically performed in each batch by PHYSBO. Thompson Sampling was selected as the acquisition function for Bayesian optimization. Please refer to the code `decision_by_nimsos_2024_06_21.py` and the PHYSBO library documentation for more technical details.

https://issp-center-dev.github.io/PHYSBO/manual/master/en/index.html

## Sumarry of File IO
- Chemspeed system
    - Input: `input_for_chemspeed.csv` (suggested 4 experimental conditions)
    - Output: `1st_result.csv`, `1st_profile.csv`, ..., `4th_profile.csv`, `4th_profile.csv` (resulted chromatograph and pressure profile of CO2 pump in SFC system)

- `evaluate_objective` program
    - Input: `1st_result.csv`, `1st_profile.csv`, ..., `4th_profile.csv`, `4th_profile.csv`
    - Output: writing objective to `candidates.csv` (table of all experimental conditions involving descriptors)
    - Setting file: `param.txt` (required parameters of quantitative analysis, e.g., wavelength, integration area, etc.)

- `decision_by_nimsos` program
    - Input: `candidates.csv`, `exp_table.csv` (table of expID, experimental conditions, and, symbolic representation of each conditions)
    - Output: `input_for_chemspeed.csv`
    - Setting file: `settings.txt`

# Used version for Actual Experiment
`nimsos 1.0.1`

`pyinstaller 5.8.0`

These programs were compiled with pyinstaller to one exe file by below PowerShell command.
```
..\pyinstaller.exe $Args[0] `
    --hidden-import=sklearn.metrics._pairwise_distances_reduction._datasets_pair `
    --hidden-import=sklearn.metrics._pairwise_distances_reduction._middle_term_computer `
    --onefile
Copy-Item -Path .\dist\$Args[0] -Destination .\$Args[0]
```

# License
This program is distributed under the MIT License.
2024 Seiji Akiyama s.aki@icredd.hokudai.ac.jp main developer
